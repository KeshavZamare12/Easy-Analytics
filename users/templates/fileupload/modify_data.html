{% extends 'users/home.html' %}
{% block title %}Modify Data{% endblock %}
{% block content %}
{% if count1 %}
<div class="container mt-5">
    <h2>Modify Your Data</h2>
    <div class="text-center mt-4">
        <a href="{% url 'upload_data' %}" class="btn btn-primary">Go to Upload</a>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-header text-center text-bg-warning">
        <h3>Modify/Check Data</h3>
    </div>
    <form method="post">
        {% csrf_token %}
        <div class="card-body overflow-auto">
            <div class="form-group">
                <div class="row p-2">
                    <div class="col-sm-4">
                        <label for="cleaningMethod">
                            <h4>Data Cleaning Method:<sup style="color:red;">*</sup></h4>
                        </label>
                    </div>
                    <div class="col-sm-8">
                        <select name="action" id="cleaningMethod" class="form-control bg-primary-hover text-center bg-opacity-10 text-bg-info"
                            required onchange="toggleFields(this.value)">
                            <option value=""selected >Select Method</option>
                            <option value="mask_data">Mask the data</option>
                            <option value="null_count">Check Sum of Null Values(Column_wise)</option>
                            <option value="see_null_data">Null Value Data</option>
                            <option value="drop_null_rows">Drop Null Values by Rows</option>
                            <option value="fill_data">Fill Data with Specific Value</option>
                            <option value="replace_value">Replace Value with Another Value</option>
                            <option value="change_dtype">Change Data Type</option>
                            <option value="drop_col">Drop Columns</option>
                            <option value="drop_duplicates">Drop Duplicate Rows</option>
                            <option value="mapping">Fill the Value by Mapping</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="ColumnsSelection" class="form-group p-2 text-bg-secondary" style="display: none;">
                <div class="row">
                    <div class="col-sm-4"><label>Select Columns:<sup style="color:red;">*</sup></label></div>
                    <div class="col-sm-8 scrollable bg-dark-hover">
                        <div class="row">
                            {% for column in columns %}
                            <div class="col-sm-4">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" name="selected_columns"
                                        value="{{ column }}">
                                    <label class="form-check-label">{{ column }}</label>
                                </div>
                            </div>
                            {% if forloop.counter|divisibleby:3 and not forloop.last %}
                        </div>
                        <div class="row">
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div id="pattern_input" class="row p-2 form-group" style="display: none;">
                <div class="row">
                <div class="col-sm-4"><label for="pattern_Value">Pattern:<sup style="color:red;">*</sup></label></div>
                <div class="col-sm-8"><input type="text" name="pattern_val" class="form-control" placeholder="ex:axxxx23, xxxx2345(use 'x' for mask values)"></div>
                </div>
            </div>

            <div id="fillValueField" class="form-group p-2" style="display: none;">
                <div class="row">
                    <div class="col-sm-4"><label for="fillingMethod">Select Method:<sup style="color:red;">*</sup></label></div>
                    <div class="col-sm-8">
                        <select name="fillingMethod" class="form-control bg-primary-hover text-center bg-opacity-10 text-bg-info"
                            id="fillingMethod" onchange="toggleSpecificValueInput()">
                            <option value="" selected disabled>-- Select Method --</option>
                            <option value="mean">Mean</option>
                            <option value="median">Median</option>
                            <option value="mode">Mode</option>
                            <option value="specific">Specific Value</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="specificValueContainer" class="row p-2 form-group" style="display: none;">
                <div class="col-sm-4"><label for="fillingValue">Specific Value:<sup style="color:red;">*</sup></label></div>
                <div class="col-sm-8"><input type="text" name="fillingValue" class="form-control"></div>
            </div>

            <div id="mappings" class="form-group p-2" style="display: none;">
                <div class="row p-2">
                    <div class="col-sm-4">
                        <label for="mapping_value">Select Column<sup style="color:red;">*</sup></label>
                    </div>
                    <div class="col-sm-8">
                        <select name="column1" class="form-control bg-primary-hover text-center bg-opacity-10 text-bg-info">
                            <option value="">Select Column</option>
                            {% for column in columns %}
                            <option value="{{ column }}">{{ column }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row p-2">
                    <div class="col-sm-4">
                        <label for="map_value">Map With<sup style="color:red;">*</sup></label>
                    </div>
                    <div class="col-sm-8">
                        <select name="column2" class="form-control bg-primary-hover text-center bg-opacity-10 text-bg-info">
                            <option value="">Select Column</option>
                            {% for column in columns %}
                            <option value="{{ column }}">{{ column }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div id="replaceValueFields" class="form-group p-2" style="display: none;">
                <div class="row p-2">
                    <div class="col-sm-4">
                        <label for="old_value">Value to Replace:<sup style="color:red;">*</sup></label>
                    </div>
                    <div class="col-sm-8">
                        <input type="text" name="old_value" class="form-control" required>
                    </div>
                </div>
                <div class="row p-2">
                    <div class="col-sm-4">
                        <label for="new_value">Replace with:<sup style="color:red;">*</sup></label>
                    </div>
                    <div class="col-sm-8">
                        <input type="text" name="new_value" class="form-control" required>
                    </div>
                </div>
            </div>

            <div id="changeDtypeField" class="form-group p-2" style="display: none;">
                <div class="row">
                    <div class="col-sm-4">
                        <label for="new_dtype">New Data Type:<sup style="color:red;">*</sup></label>
                    </div>
                    <div class="col-sm-8">
                        <select name="new_dtype" class="form-control bg-primary-hover text-center bg-opacity-10 text-bg-info">
                            <option value="int">Integer</option>
                            <option value="float">Float</option>
                            <option value="str">String</option>
                            <option value="bool">Boolean</option>
                            <option value="date">Date</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="text-center form-group p-2">
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </form>
</div>
    {% if modified_data %}
    <div class="card overflow-auto">
        <div class="card-header">
            <div class="row">
                <div class="col-sm-8 text-left">
                    <h4>Modified Data:</h4>
                </div>
                <div class="col-sm-4">
                    <a href="{% url 'download_file' id=0 %}" class="btn btn-grd-primary"><i class="fa fa-download"></i>Download </a>
                    <a href="{% url 'visualize_data' %}" class="btn btn-grd-primary" target="_blank">Data Visualization</a>
                    <a href="{% url 'analyze_data'%}" class="btn btn-grd-primary">Data Analysis</a>
                </div>
            </div>
        </div>
        <div class="card-body overflow-auto">
            <div class="table-responsive">
                {{ modified_data|safe }}
            </div>
        </div>
        
    </div>
    {% endif %}

<script>
    function toggleFields(action) {
        const columnSelection = document.getElementById('ColumnsSelection');
        const fillValueField = document.getElementById('fillValueField');
        const replaceValueFields = document.getElementById('replaceValueFields');
        const changeDtypeField = document.getElementById('changeDtypeField');
        const mappings = document.getElementById('mappings');
        const pattern_input=document.getElementById('pattern_input');

        // Reset required attributes
        const inputs = [fillValueField, replaceValueFields, changeDtypeField, mappings];
        inputs.forEach(field => {
            field.querySelectorAll('input, select').forEach(input => {
                input.required = false;
            });
            field.style.display = 'none'; // Hide all fields initially
        });
        if (!['drop_duplicates', 'mapping', 'null_count', 'see_null_data'].includes(action)) {
           columnSelection.style.display = 'block'; 
        }
        else{
            columnSelection.style.display='none';
        }

        if (action === 'fill_data') {
            fillValueField.style.display = 'block';
            fillValueField.querySelector('select').required = true; // Set required
        } else if (action === 'replace_value') {
            replaceValueFields.style.display = 'block';
            replaceValueFields.querySelector('input[name="old_value"]').required = true; // Set required
            replaceValueFields.querySelector('input[name="new_value"]').required = true; // Set required
        } else if (action === 'change_dtype') {
            changeDtypeField.style.display = 'block';
        } else if (action === 'mapping') {
            mappings.style.display = 'block';
        }
        else if (action==='mask_data'){
            pattern_input.style.display='block';
        }
    }

    function toggleSpecificValueInput() {
        const dropdown = document.getElementById('fillingMethod');
        const specificValueContainer = document.getElementById('specificValueContainer');
        specificValueContainer.style.display = (dropdown.value === 'specific') ? 'block' : 'none';
    }

</script>
{% endif %}
{% endblock %}